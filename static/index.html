<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Chat</title>
    <style>
      main {
        display: flex;
        align-items: start;
        justify-content: space-evenly;
        flex-direction: column;
        @media (orientation: landscape) {
          flex-direction: row;
        }
      }
      dialog {
        display: none;
        place-content: center;
        place-items: center;
        text-align: center;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(5px);
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        font-size: 2rem;
      }
      form {
        fieldset {
          width: 32rem;
          border: none;
          label {
            display: flex;
            flex-direction: column;
            select {
              height: 2rem;
            }
            textarea {
              min-height: 4rem;
            }
          }
        }
      }
    </style>
  </head>
  <body>
    <main>
      <section>
        <h2>Config</h2>
        <template id="template-server">
          <fieldset>
            <label> Name <input name="name" required /> </label>
            <label> URL <input name="url" required /> </label>
            <label> Model <input name="model" required /> </label>
            <label> Key <input name="key" type="password" /> </label>
            <button type="button" onclick="this.parentElement.remove()">
              ×
            </button>
            <input type="radio" name="last" inert />
          </fieldset>
        </template>
        <form id="form-config" method="POST" action="/config">
          <lable>
            Sticky
            <input
              type="checkbox"
              name="sticky"
              title="sticky"
              onchange="updateConfig()"
            />
          </lable>
          <lable>
            Random
            <input
              type="checkbox"
              name="random"
              title="random"
              onchange="updateConfig()"
            />
          </lable>
          <button
            id="button-appendserver"
            type="button"
            onclick="appendServer()"
          >
            +
          </button>
          <input type="button" value="update" onclick="updateConfig()" />
        </form>
      </section>
      <section>
        <h2>Test Chat</h2>
        <template id="template-message">
          <fieldset>
            <label>
              Role:
              <select name="role">
                <option selected>user</option>
                <option>assistant</option>
                <option>system</option>
              </select>
            </label>
            <label> Content: <textarea name="content"> </textarea></label>
            <button type="button" onclick="this.parentElement.remove()">
              ×
            </button>
          </fieldset>
        </template>
        <form id="form-test" method="POST" action="/messages">
          <button
            id="button-appendmessage"
            type="button"
            onclick="appendMessage()"
          >
            +
          </button>
          <input type="button" value="test" onclick="sendMessage()" />
        </form>
      </section>
    </main>
    <dialog>Loading</dialog>
    <script type="module">
      let loading = false;
      const startLoading = () => {
        loading = true;
        document.querySelector("dialog").style.display = "block";
      };
      const stopLoading = () => {
        loading = false;
        document.querySelector("dialog").style.display = "none";
      };
      const appendMessage = ({ role = null, content = null } = {}) => {
        const message = document.getElementById("template-message");
        const form = document.getElementById("form-test");
        const button = document.getElementById("button-appendmessage");
        const clone = message.content.cloneNode(true);
        clone.querySelector("[name=role]").value = role || "user";
        clone.querySelector("[name=content]").value = content || "";
        form.insertBefore(clone, button);
      };
      window.appendServer = ({
        name = null,
        url = null,
        key = null,
        model,
      } = {}) => {
        const server = document.getElementById("template-server");
        const form = document.getElementById("form-config");
        const button = document.getElementById("button-appendserver");
        const clone = server.content.cloneNode(true);
        clone.querySelector("[name=name]").value = name || "";
        clone.querySelector("[name=url]").value = url || "";
        clone.querySelector("[name=key]").value = key || "";
        clone.querySelector("[name=model]").value = model || "";
        form.insertBefore(clone, button);
      };
      const setUsed = (used) => {
        if (used === "") {
          return;
        }
        const input = document.querySelectorAll(`[name=name]`)[used];
        // const input = getInputsByValue(used);
        const parent = input.closest("fieldset");
        const radio = parent.querySelector("[type=radio]");
        radio.checked = true;
      };
      const setSticky = (value) => {
        document.querySelector("[name=sticky]").checked = value;
      };
      const setRandom = (value) => {
        document.querySelector("[name=random]").checked = value;
      };
      window.sendMessage = async () => {
        if (loading) {
          return;
        }
        try {
          startLoading();
          const formData = new FormData(document.getElementById("form-test"));
          const response = await fetch("/messages", {
            method: "POST",
            body: formData,
            headers: {
              // "Content-Type": "application/x-www-form-urlencoded",
            },
          });
          if (!response.ok) {
            return;
          }
          const json = await response.json();
          appendMessage(json.choices[0].message);
          appendMessage();
          setUsed(response.headers.get("x-used-option"));
        } finally {
          stopLoading();
        }
      };
      window.updateConfig = async () => {
        if (loading) {
          return;
        }
        try {
          startLoading();
          const formData = new FormData(document.getElementById("form-config"));
          const response = await fetch("/config", {
            method: "POST",
            body: formData,
          });
          if (response.ok) {
            response.json().then((config) => {
              console.log("config updated:", { config });
            });
          }
        } finally {
          stopLoading();
        }
      };
      startLoading();
      const configResponse = await fetch("/config");
      const lastUsed = configResponse.headers.get("x-used-option");
      const config = await configResponse.json();
      appendMessage({
        role: "system",
        content: "You are a helpful assisstant",
      });
      appendMessage();
      setSticky(config.sticky);
      setRandom(config.random);
      for (const { name, url, key, model } of config.servers) {
        appendServer({ name, url, key, model });
      }
      setUsed(lastUsed);
      stopLoading();
    </script>
  </body>
</html>
